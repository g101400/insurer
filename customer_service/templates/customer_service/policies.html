{% extends 'base.html' %}
{% load bootstrap4 %}
{% load render_table from django_tables2 %}

{% block title %}Polices{% endblock %}

{% block content %}
    <h2>Policies</h2>
    {% if filter %}
        {{ filter.form.media }}
        <form action="" method="get" class="form form-inline">
            {% bootstrap_form filter.form layout='inline' %}
            {% bootstrap_button 'Filter' %}
        </form>
    {% endif %}

    {% render_table table %}

    {% include "customer_service/send_sms_dialog.html" with dialog_id="send-sms-dialog" %}
    {% include "bsmodals/confirm.html" %}
    {% include "bsmodals/error.html" %}
    {% include "bsmodals/alert.html" %}

    <p id="message-sms-url" data-url="{{ message_sms_url }}"></p>
{% endblock %}

{% block javascript %}
    <script src="/static/bsmodals/bsmodals.js"></script>
    <script src="/static/bsmodals/restapi.js"></script>

    <script>
        {# From Django doc #}

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
        const urlMessageCreate = $('#message-sms-url').attr('data-url');

        function getDataAjax(url) {
            let result = '';
            $.ajax({
                method: 'GET',
                url: url,
                async: false
            })
                .done(function (data) {
                    result = data;
                })
                .fail(function (data) {
                    result = data;
                    console.log("error");
                })
            return result;
        }

        {#function putDataAjax(putData, url) {#}
        {#    var res = $.ajax({#}
        {#        method: 'PUT',#}
        {#        url: url,#}
        {#async: false,#}
        {#        beforeSend: function (xhr) {#}
        {#            xhr.setRequestHeader("X-CSRFToken", csrftoken)#}
        {#        },#}
        {#        data: putData,#}
        {#    })#}
        {#        .done(function (data, status, jqXHR) {#}
        {#            console.log('R: ', data);#}
        {#            console.log('Status: ', status);#}
        {#            console.log('jqXHR: ', jqXHR.status);#}
        {#        })#}
        {#        .fail(function (data) {#}
        {#            console.log("error");#}
        {#        })#}
        {#    return res;#}

        $("table.table > tbody > tr").delegate('td', 'click', function (event) {
            let yes = '✔';
            let no = '❌';
            let td = $(this);
            let thisTdClass = td.attr('class');
            let resultAfterTheCall = ['is_reinsured', 'is_reinsured_another_company', 'is_impossible_to_call',
                'is_called_will_insure', 'is_called_will_not_insure'];

            let idPolicy = td.parent('tr').attr('data-id');
            let numberPolicy = td.parent('tr').find('td.number').text();
            let customerPolicy = td.parent('tr').find('td.customer').text();
            let end_datePolicy = td.parent('tr').find('td.end_date').text();

            let thisButton = $(this).find('button');

            if (resultAfterTheCall.includes(thisTdClass)) {
                bsmodals_confirm('Policy ' + numberPolicy + ' update',
                    'Are you sure you want to update the policy ?', function (result) {
                        if (result) {
                            let dataUrlPolicy = td.parent('tr').attr('data-url');
                            let data = getDataAjax(dataUrlPolicy);

                            data[thisTdClass] = td.find('span').attr('class') !== 'true';

                            $.ajax({
                                method: 'PUT',
                                url: dataUrlPolicy,
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                                },
                                data: data,
                            })
                                .done(function (data, status, jqXHR) {
                                    {#console.log('jqXHR: ', jqXHR.status);#}
                                    if (td.find('span').is('.true')) {
                                        td.find('span').removeClass('true').addClass('false');
                                        td.find('span').empty().append(no);
                                    } else {
                                        td.find('span').removeClass('false').addClass('true');
                                        td.find('span').empty().append(yes);
                                    }
                                })
                                .fail(function (data) {
                                    bsmodals_error(data.statusText, "btn-warning");
                                })
                        }
                    }, yes_text = 'YES', yes_style = 'btn-success', no_text = 'NO', no_style = 'btn-secondary'
                );
            }
            {#else if (thisButton.attr('class', 'send_sms')) {#}
            {#bsmodals_confirm(titleModals, msgModals, function (result) {#}
            {#        if (result) {#}
            {#            $.ajax({#}
            {#                method: 'POST',#}
            {#                url: urlMessageCreate,#}
            {#                beforeSend: function (xhr) {#}
            {#                    xhr.setRequestHeader("X-CSRFToken", csrftoken)#}
            {#                },#}
            {#                data: {#}
            {#"body": "Hello ...",#}
            {#                    "insurance_policy": idPolicy#}
            {#                },#}
            {#            })#}
            {#                .done(function (data, status, jqXHR) {#}
            {#console.log('jqXHR: ', jqXHR.status);#}
            {#                        bsmodals_alert('Success!', 'The message was sent successfuly')#}
            {#                    }#}
            {#                )#}
            {#                .fail(function (data) {#}
            {#                    bsmodals_error(data.statusText, "btn-warning");#}
            {#                })#}
            {#        }#}
            {#    }, yes_text = 'YES', yes_style = 'btn-success', no_text = 'NO',#}
            {#    no_style = 'btn-secondary');#}


            if ($(this).find('.send_sms')) {
                let messageSendSms = "".concat(customerPolicy, ', ', 'insurance policy', ' ', numberPolicy, ' ', 'expires on', ' ', end_datePolicy)
                let msgModals = 'Are you sure you want to send the sms?'

                {#bsmodals_confirm(messageSendSms, msgModals, function (result) {#}
                {#            if (result) {#}
                {#                $.ajax({#}
                {#                    method: 'POST',#}
                {#                    url: urlMessageCreate,#}
                {#                    beforeSend: function (xhr) {#}
                {#                        xhr.setRequestHeader("X-CSRFToken", csrftoken)#}
                {#                    },#}
                {#                    data: {#}
                {#                        "body": messageSendSms,#}
                {#                        "insurance_policy": idPolicy#}
                {#                    },#}
                {#                })#}
                {#                    .done(function (data, status, jqXHR) {#}
                {#                            console.log('jqXHR: ', jqXHR.status);#}
                {#                            bsmodals_alert('Success!', 'The message was sent successfuly')#}
                {#                        }#}
                {#                    )#}
                {#                    .fail(function (data) {#}
                {#                        bsmodals_error(data.statusText, "btn-warning");#}
                {#                    })#}
                {#            }#}
                {#        }, yes_text = 'YES', yes_style = 'btn-success', no_text = 'NO',#}
                {#        no_style = 'btn-secondary');#}


                let sendSmsDialog = new FormModal('send-sms-dialog');
                let data = {
                    'number_policy': numberPolicy,
                    'customer': customerPolicy,
                    'message_send_sms': messageSendSms
                }
                sendSmsDialog.show(data);

                $('#send-sms-dialog-close').click(function () {
                    console.debug('Click on button Close');
                });

                $('#send-sms-dialog-update').click(function () {
                    console.debug('Click on button Update');
                    console.debug(sendSmsDialog.dialog_id);
                    let msgAfterUpdate = sendSmsDialog.modal.find('#message_send_sms').val();

                    bsmodals_confirm(msgAfterUpdate, msgModals, function (result) {
                            if (result) {
                                $.ajax({
                                    method: 'POST',
                                    url: urlMessageCreate,
                                    beforeSend: function (xhr) {
                                        xhr.setRequestHeader("X-CSRFToken", csrftoken)
                                    },
                                    data: {
                                        "body": msgAfterUpdate,
                                        "insurance_policy": idPolicy
                                    },
                                })
                                    .done(function (data, status, jqXHR) {
                                            console.log('jqXHR: ', jqXHR.status);
                                            bsmodals_alert('Success!', 'The message was sent successfuly')
                                        }
                                    )
                                    .fail(function (data) {
                                        bsmodals_error(data.statusText, "btn-warning");
                                    })
                            }
                        }, yes_text = 'YES', yes_style = 'btn-success', no_text = 'NO',
                        no_style = 'btn-secondary');

                });
            }


        });

    </script>
{% endblock %}

