{% extends 'base.html' %}
{% load bootstrap4 %}
{% load render_table from django_tables2 %}

{% block title %}Polices{% endblock %}

{% block content %}
    <h2>Policies</h2>

    {% if filter %}
        {{ filter.form.media }}
        <form action="" method="get" class="form form-inline">
            {% bootstrap_form filter.form layout='inline' %}
            {% bootstrap_button 'Filter' %}
        </form>
    {% endif %}

    {% render_table table %}

    {% include "bsmodals/confirm.html" %}

{% endblock %}

{% block javascript %}
    <script src="/static/bsmodals/bsmodals.js"></script>
    {#    <script src="/static/bsmodals/restapi.js"></script>#}

    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function putDataAjax(putData, url) {
            var result = "";
            $.ajax({
                method: 'PUT',
                url: url,
                async: false,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                },
                data: putData,
            })
                .done(function (data) {
                    result = data;
                })
                .fail(function (data) {
                    console.log("error");
                })
            return result;
        }

        function getDataAjax(url) {
            var result = '';
            $.ajax({
                method: 'GET',
                url: url,
                async: false
            })
                .done(function (data) {
                    result = data;
                })
                .fail(function (data) {
                    result = data;
                    console.log("error");
                })
            return result;
        }

        $("table.table > tbody > tr").delegate('td', 'click', function (event) {
            var tr = $(this);
            var thisTdClass = $(this).attr('class');
            var resultAfterTheCall = ['is_reinsured', 'is_reinsured_another_company', 'is_impossible_to_call',
                'is_called_will_insure', 'is_called_will_not_insure'];

            if (resultAfterTheCall.includes(thisTdClass)) {
                event.preventDefault();

                //var numberPolicy = tr.parent('tr').find('td')[1];
                var numberPolicy = tr.parent('tr').find('td.number').text();

                bsmodals_confirm('Policy ' + numberPolicy + ' update',
                    'Are you sure you want to update the policy ?', function (result) {
                        if (result) {
                            //var policyId = $(this).parent('tr').attr('data-id');
                            var dataUrlPolicy = tr.parent('tr').attr('data-url');
                            var data = getDataAjax(dataUrlPolicy);

                            var yes = '✔';
                            var no = '❌';
                            if (tr.find('span').is('.true')) {
                                tr.find('span').removeClass('true').addClass('false');
                                tr.find('span').empty().append(no);
                            } else {
                                tr.find('span').removeClass('false').addClass('true');
                                tr.find('span').empty().append(yes);
                            }

                            data[thisTdClass] = tr.find('span').attr('class');
                            //var putResult = putDataAjax(data, dataUrlPolicy);
                        }
                    }, yes_text = 'YES', yes_style = 'btn-success', no_text = 'NO',
                    no_style = 'btn-secondary');
            }
        });

    </script>
{% endblock %}

