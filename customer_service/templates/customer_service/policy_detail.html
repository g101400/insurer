{% extends 'base.html' %}
{% load bootstrap4 %}
{% load i18n %}
{% block title %}{{ policy.number }}{% endblock %}

{% block content %}
    <div class="h3 p-3 mb-2 bg-dark text-white">{{ policy.number }}
        <span class="badge badge-pill badge-secondary">Policy detail</span></div>

    <!-- Result after the call to the customer -->
    <h4 id="result-after-call" data-insurance-policy-update-url="{% url 'api-customer-service:api-insurance-policy-update' pk=policy.id %}">
        <a href="#" id="is_reinsured"
           class="badge badge-{% if policy.is_reinsured %}success{% else %}secondary{% endif %}"> {% trans 'Reinsured' %}</a>
        <a href="#" id="is_reinsured_another_company"
           class="badge badge-{% if policy.is_reinsured_another_company %}success{% else %}secondary{% endif %}"> {% trans 'Reinsured in another company' %}</a>
        <a href="#" id="is_impossible_to_call"
           class="badge badge-{% if policy.is_impossible_to_call %}success{% else %}secondary{% endif %}"> {% trans 'Impossible to call' %}</a>
        <a href="#" id="is_called_will_insure"
           class="badge badge-{% if policy.is_called_will_insure %}success{% else %}secondary{% endif %}"> {% trans 'Was called and will insure' %}</a>
        <a href="#" id="is_called_will_not_insure"
           class="badge badge-{% if policy.is_called_will_not_insure %}success{% else %}secondary{% endif %}"> {% trans 'Was called and will not insure' %}</a>
    </h4>

    <div class="row">

        <!-- Policy information -->
        <div class="col-sm">
            <div class="pl-3 mb-1 bg-info text-white">Policy information</div>
            {% if policy.sticker %}
                <div class="p-2 mb-2 bg-dark text-white"><small>Sticker: </small>{{ policy.sticker }}</div>
            {% endif %}
            <div class="p-3 mb-2 bg-dark text-white"><small>Registration Date: </small>{{ policy.registration_date }}
            </div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Begin Date: </small>{{ policy.begin_date }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>End Date: </small>{{ policy.end_date }}</div>

            <div class="p-3 mb-2 bg-dark text-white"><small>Insurance Code: </small>{{ policy.insurance_code }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Sum Insured: </small>{{ policy.sum_insured }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Price: </small>{{ policy.price }}</div>

            {% if policy.bonus %}
                <div class="p-3 mb-2 bg-dark text-white"><small>Bonus: </small>{{ policy.bonus }}</div>
            {% endif %}

            <div class="p-3 mb-2 bg-dark text-white"><small>Territory: </small>{{ policy.territory }}</div>
        </div>

        <!-- Customer information -->
        <div class="col-sm">
            <div class="pl-3 mb-1 bg-info text-white">Customer information</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Customer: </small>{{ policy.customer.name }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Ind Number: </small>{{ policy.customer.ind_number }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Address: </small>{{ policy.customer.address }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Country: </small>{{ policy.customer.country }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Phone: </small>{{ policy.customer.phone }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Customer Type: </small>{{ policy.customer.customer_type }}
            </div>
        </div>

        <!-- Car information -->
        <div class="col-sm">
            <div class="pl-3 mb-1 bg-info text-white">Car information</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Mark: </small>{{ policy.car.mark }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Model: </small>{{ policy.car.model }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Registration
                Place: </small>{{ policy.car.registration_place }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Registration
                Country: </small>{{ policy.car.registration_country }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Registration
                Number: </small>{{ policy.car.registration_number }}</div>
            <div class="p-3 mb-2 bg-dark text-white"><small>Vin Code: </small>{{ policy.car.vin_code }}</div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        var urlApiInsurancePolicyUpdate = $('#result-after-call').attr('data-insurance-policy-update-url');

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        function putDataAjax(data) {
            $.ajax({
                method: 'PUT',
                url: urlApiInsurancePolicyUpdate,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                },
                data: data,
            })
                .done(function (data) {
                })
                .fail(function (data) {
                    console.log("error");
                })
        }

        function getDataAjax() {
            var result = '';
            $.ajax({
                method: 'GET',
                url: urlApiInsurancePolicyUpdate,
                async: false
            })
                .done(function (data) {
                    result = data;
                })
                .fail(function (data) {
                    result = data;
                    console.log("error");
                })
            return result;
        }

        function changeClass() {
            var data = getDataAjax();
            var this_bool;

            if ($(this).hasClass("badge-success") === true) {
                this_bool = true;
                $(this).removeClass("badge-success").addClass("badge-secondary");
            } else {
                this_bool = false;
                $(this).removeClass("badge-secondary").addClass("badge-success");
            }

            var this_id = $(this).attr('id');
            data[this_id] = !this_bool;
            putDataAjax(data);
        }

        $("#is_reinsured").on("click", changeClass);
        $("#is_reinsured_another_company").on("click", changeClass);
        $("#is_impossible_to_call").on("click", changeClass);
        $("#is_called_will_insure").on("click", changeClass);
        $("#is_called_will_not_insure").on("click", changeClass);

    </script>
{% endblock %}
